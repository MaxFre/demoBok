<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Var kan jag streama?</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Inter', sans-serif;
      background: #0d0d14;
      color: #e2e8f0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* ‚îÄ‚îÄ SETUP OVERLAY ‚îÄ‚îÄ */
    #setup-overlay {
      position: fixed;
      inset: 0;
      background: #0d0d14;
      z-index: 100;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      text-align: center;
    }

    #setup-overlay h2 {
      font-family: 'Playfair Display', serif;
      font-size: 2rem;
      background: linear-gradient(90deg,#a78bfa,#f0c060);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 14px;
    }

    #setup-overlay p {
      color: #6b7fa0;
      max-width: 500px;
      line-height: 1.6;
      margin-bottom: 28px;
      font-size: 0.95rem;
    }

    #setup-overlay p a { color: #a78bfa; }

    .setup-field {
      display: flex;
      gap: 10px;
      width: 100%;
      max-width: 480px;
      margin-bottom: 14px;
    }

    .setup-field input {
      flex: 1;
      background: #161626;
      border: 2px solid #2a2a4a;
      border-radius: 12px;
      padding: 14px 18px;
      font-size: 1rem;
      color: #e2e8f0;
      outline: none;
      font-family: monospace;
      transition: border-color 0.2s;
    }

    .setup-field input:focus { border-color: #a78bfa; }

    .setup-field button {
      background: linear-gradient(135deg,#7c3aed,#a78bfa);
      color: #fff;
      border: none;
      border-radius: 12px;
      padding: 0 24px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
      white-space: nowrap;
    }

    .setup-field button:hover { opacity: 0.85; }

    #setup-error { color: #f87171; font-size: 0.85rem; display: none; }

    .setup-badge {
      background: #1e1030;
      border: 1px solid #7c3aed40;
      border-radius: 8px;
      padding: 10px 18px;
      font-size: 0.8rem;
      color: #7c3aed;
      margin-top: 20px;
    }

    /* ‚îÄ‚îÄ MAIN APP ‚îÄ‚îÄ */
    header {
      width: 100%;
      padding: 60px 20px 30px;
      text-align: center;
    }

    header h1 {
      font-family: 'Playfair Display', serif;
      font-size: clamp(2rem, 6vw, 3.8rem);
      background: linear-gradient(90deg, #a78bfa, #f0c060, #f87171);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 10px;
    }

    header p { color: #6b7fa0; font-size: 1rem; font-weight: 300; }

    .search-wrap {
      position: relative;
      width: 100%;
      max-width: 700px;
      padding: 0 20px;
      margin-bottom: 8px;
    }

    .search-wrap input {
      width: 100%;
      background: #161626;
      border: 2px solid #2a2a4a;
      border-radius: 16px;
      padding: 18px 60px 18px 24px;
      font-size: 1.1rem;
      color: #e2e8f0;
      outline: none;
      transition: border-color 0.25s, box-shadow 0.25s;
      font-family: 'Inter', sans-serif;
    }

    .search-wrap input::placeholder { color: #404060; }

    .search-wrap input:focus {
      border-color: #a78bfa;
      box-shadow: 0 0 0 4px #a78bfa18;
    }

    .search-icon {
      position: absolute;
      right: 36px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1.3rem;
      pointer-events: none;
    }

    #suggestions {
      width: calc(100% - 40px);
      max-width: 700px;
      background: #161626;
      border: 1px solid #2a2a4a;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 32px;
      display: none;
    }

    .suggestion-item {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 12px 16px;
      cursor: pointer;
      transition: background 0.15s;
      border-bottom: 1px solid #1e1e30;
    }

    .suggestion-item:last-child { border-bottom: none; }
    .suggestion-item:hover { background: #1e1e38; }

    .suggestion-item img {
      width: 36px;
      height: 54px;
      object-fit: cover;
      border-radius: 6px;
      flex-shrink: 0;
    }

    .sug-poster-ph {
      width: 36px; height: 54px;
      background: #2a2a4a;
      border-radius: 6px;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.2rem; flex-shrink: 0;
    }

    .sug-title { font-weight: 600; font-size: 0.95rem; }
    .sug-year { color: #6b7fa0; font-size: 0.8rem; margin-top: 2px; }

    #loading {
      display: none;
      padding: 40px;
      text-align: center;
      color: #6b7fa0;
    }

    .loader {
      display: inline-block;
      width: 38px; height: 38px;
      border: 3px solid #2a2a4a;
      border-top-color: #a78bfa;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: 12px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    #result {
      width: calc(100% - 40px);
      max-width: 900px;
      margin-bottom: 60px;
      display: none;
    }

    .show-header {
      display: flex;
      gap: 24px;
      margin-bottom: 32px;
      align-items: flex-start;
    }

    .show-poster {
      width: 130px; min-width: 130px; height: 195px;
      border-radius: 12px;
      object-fit: cover;
      box-shadow: 0 8px 32px #00000080;
    }

    .show-poster-ph {
      width: 130px; min-width: 130px; height: 195px;
      border-radius: 12px;
      background: #1e1e30;
      display: flex; align-items: center; justify-content: center;
      font-size: 3rem;
    }

    .show-meta { flex: 1; padding-top: 4px; }

    .show-meta h2 {
      font-family: 'Playfair Display', serif;
      font-size: clamp(1.4rem, 3vw, 2rem);
      color: #f0f0f0;
      margin-bottom: 6px;
      line-height: 1.2;
    }

    .year-genre { color: #6b7fa0; font-size: 0.88rem; margin-bottom: 12px; }

    .overview {
      font-size: 0.9rem; color: #94a3b8; line-height: 1.6;
      display: -webkit-box;
      -webkit-line-clamp: 4;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .stream-section {
      background: #12121f;
      border: 1px solid #1e1e30;
      border-radius: 16px;
      padding: 24px;
    }

    .stream-section h3 {
      font-size: 1rem; font-weight: 600;
      color: #a78bfa;
      margin-bottom: 20px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .stream-category { margin-bottom: 22px; }
    .stream-category:last-child { margin-bottom: 0; }

    .cat-label {
      font-size: 0.75rem; color: #4a5568;
      text-transform: uppercase; letter-spacing: 1px;
      margin-bottom: 12px; font-weight: 600;
    }

    .provider-list { display: flex; flex-wrap: wrap; gap: 16px; }

    .provider {
      display: flex; flex-direction: column;
      align-items: center; gap: 6px;
    }

    .provider img {
      width: 58px; height: 58px;
      border-radius: 14px;
      box-shadow: 0 4px 12px #00000060;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .provider:hover img {
      transform: scale(1.1);
      box-shadow: 0 8px 20px #00000080;
    }

    .provider span {
      font-size: 0.7rem; color: #6b7fa0;
      text-align: center; max-width: 72px;
    }

    .no-stream {
      padding: 32px; text-align: center;
      color: #4a5568; font-size: 1rem;
    }

    .no-stream .emoji { font-size: 2.5rem; display: block; margin-bottom: 10px; }

    .reset-key {
      font-size: 0.75rem; color: #2a3050;
      cursor: pointer; text-align: right;
      width: calc(100% - 40px); max-width: 700px;
      margin-bottom: 12px;
    }

    .reset-key:hover { color: #a78bfa; }

    footer {
      margin-top: auto; padding: 20px;
      text-align: center; font-size: 0.78rem; color: #2a3040;
    }

    @media(max-width:500px) {
      .show-header { flex-direction: column; }
      .show-poster, .show-poster-ph { width:100%; min-width:unset; height:200px; }
    }
  </style>
</head>
<body>

<!-- ENG√ÖNGS-SETUP OVERLAY -->
<div id="setup-overlay">
  <h2>üì∫ Var kan jag streama?</h2>
  <p>
    Appen anv√§nder <strong style="color:#e2e8f0">TMDb</strong> f√∂r att h√§mta streaminginfo.
    Du beh√∂ver en gratis API-nyckel ‚Äî tar bara 1 minut att skapa.
    <br><br>
    <a href="https://www.themoviedb.org/settings/api" target="_blank">Klicka h√§r ‚Üí Skapa gratis konto ‚Üí Beg√§r API-nyckel (v3)</a>
  </p>
  <div class="setup-field">
    <input type="text" id="setupKey" placeholder="Klistra in din API-nyckel..." />
    <button onclick="saveKey()">Spara</button>
  </div>
  <div id="setup-error">Ogiltig nyckel ‚Äî kontrollera och f√∂rs√∂k igen.</div>
  <div class="setup-badge">üîí Nyckeln sparas bara lokalt i din webbl√§sare ‚Äî aldrig skickad n√•gonstans</div>
</div>

<!-- HUVUD-APP -->
<header>
  <h1>üì∫ Var kan jag streama?</h1>
  <p>Skriv in en serie och se var du kan titta i Sverige üá∏üá™</p>
</header>

<div class="reset-key" onclick="resetKey()">Byt API-nyckel</div>

<div class="search-wrap">
  <input type="text" id="searchInput" placeholder="T.ex. Succession, Breaking Bad, Svensson Svensson..." autocomplete="off" />
  <span class="search-icon">üîç</span>
</div>

<div id="suggestions"></div>
<div id="loading"><div class="loader"></div><div>H√§mtar info...</div></div>
<div id="result"></div>

<footer>Data fr√•n <a href="https://www.themoviedb.org" target="_blank" style="color:#4a5568">TMDb</a> ¬∑ Streaminginfo g√§ller f√∂r Sverige</footer>

<script>
  const overlay = document.getElementById('setup-overlay');
  const searchInput = document.getElementById('searchInput');
  const suggestionsEl = document.getElementById('suggestions');
  const resultEl = document.getElementById('result');
  const loadingEl = document.getElementById('loading');

  function getKey() { return localStorage.getItem('tmdb_key') || ''; }

  function boot() {
    if (getKey()) { overlay.style.display = 'none'; }
  }

  async function saveKey() {
    const val = document.getElementById('setupKey').value.trim();
    if (!val) return;
    // validate
    const test = await fetch(`https://api.themoviedb.org/3/configuration?api_key=${val}`);
    if (!test.ok) {
      document.getElementById('setup-error').style.display = 'block';
      return;
    }
    localStorage.setItem('tmdb_key', val);
    overlay.style.display = 'none';
  }

  function resetKey() {
    localStorage.removeItem('tmdb_key');
    document.getElementById('setupKey').value = '';
    document.getElementById('setup-error').style.display = 'none';
    overlay.style.display = 'flex';
  }

  boot();

  let debounce;
  searchInput.addEventListener('input', () => {
    clearTimeout(debounce);
    const q = searchInput.value.trim();
    if (q.length < 2) { suggestionsEl.style.display = 'none'; return; }
    debounce = setTimeout(() => searchShows(q), 350);
  });

  searchInput.addEventListener('keydown', e => {
    if (e.key === 'Escape') suggestionsEl.style.display = 'none';
  });

  document.addEventListener('click', e => {
    if (!e.target.closest('.search-wrap') && !e.target.closest('#suggestions'))
      suggestionsEl.style.display = 'none';
  });

  async function searchShows(q) {
    const key = getKey();
    try {
      const res = await fetch(`https://api.themoviedb.org/3/search/tv?query=${encodeURIComponent(q)}&api_key=${key}&language=sv-SE`);
      const data = await res.json();
      renderSuggestions(data.results?.slice(0, 7) || []);
    } catch {}
  }

  function renderSuggestions(shows) {
    if (!shows.length) { suggestionsEl.style.display = 'none'; return; }
    suggestionsEl.innerHTML = shows.map(s => {
      const year = s.first_air_date?.slice(0, 4) || '‚Äì';
      const poster = s.poster_path
        ? `<img src="https://image.tmdb.org/t/p/w92${s.poster_path}" alt="">`
        : `<div class="sug-poster-ph">üé¨</div>`;
      return `<div class="suggestion-item" data-id="${s.id}">
        ${poster}
        <div><div class="sug-title">${s.name}</div><div class="sug-year">${year}</div></div>
      </div>`;
    }).join('');
    suggestionsEl.style.display = 'block';
    suggestionsEl.querySelectorAll('.suggestion-item').forEach(el =>
      el.addEventListener('click', () => {
        searchInput.value = el.querySelector('.sug-title').textContent;
        suggestionsEl.style.display = 'none';
        loadShow(el.dataset.id);
      })
    );
  }

  async function loadShow(id) {
    const key = getKey();
    resultEl.style.display = 'none';
    loadingEl.style.display = 'block';
    try {
      const [dRes, pRes] = await Promise.all([
        fetch(`https://api.themoviedb.org/3/tv/${id}?api_key=${key}&language=sv-SE`),
        fetch(`https://api.themoviedb.org/3/tv/${id}/watch/providers?api_key=${key}`)
      ]);
      renderResult(await dRes.json(), (await pRes.json()).results?.SE || null);
    } catch {}
    finally { loadingEl.style.display = 'none'; }
  }

  function renderResult(show, providers) {
    const poster = show.poster_path
      ? `<img class="show-poster" src="https://image.tmdb.org/t/p/w300${show.poster_path}" alt="${show.name}">`
      : `<div class="show-poster-ph">üé¨</div>`;

    const year = show.first_air_date?.slice(0, 4) || '‚Äì';
    const genres = show.genres?.map(g => g.name).join(', ') || '‚Äì';
    const overview = show.overview || 'Ingen beskrivning tillg√§nglig.';

    const cats = [
      { key: 'flatrate', label: '‚úÖ Ing√•r i prenumeration' },
      { key: 'free',     label: 'üÜì Gratis' },
      { key: 'ads',      label: 'üì∫ Gratis med reklam' },
      { key: 'rent',     label: 'üí∏ Hyrs' },
      { key: 'buy',      label: 'üõí K√∂ps' },
    ];

    let streamHtml = '';
    if (!providers) {
      streamHtml = `<div class="no-stream"><span class="emoji">üòî</span>Hittades inte p√• svenska streamingtj√§nster.</div>`;
    } else {
      const sections = cats.filter(c => providers[c.key]?.length).map(c => `
        <div class="stream-category">
          <div class="cat-label">${c.label}</div>
          <div class="provider-list">
            ${providers[c.key].map(p => `
              <div class="provider">
                <img src="https://image.tmdb.org/t/p/original${p.logo_path}" alt="${p.provider_name}" title="${p.provider_name}">
                <span>${p.provider_name}</span>
              </div>`).join('')}
          </div>
        </div>`).join('');
      streamHtml = sections || `<div class="no-stream"><span class="emoji">üòî</span>Hittades inte p√• svenska streamingtj√§nster.</div>`;
    }

    resultEl.innerHTML = `
      <div class="show-header">
        ${poster}
        <div class="show-meta">
          <h2>${show.name}</h2>
          <div class="year-genre">${year} ¬∑ ${genres}</div>
          <p class="overview">${overview}</p>
        </div>
      </div>
      <div class="stream-section">
        <h3>üá∏üá™ Tillg√§nglig i Sverige via</h3>
        ${streamHtml}
        ${providers?.link ? `<div style="margin-top:18px;text-align:right"><a href="${providers.link}" target="_blank" style="font-size:0.78rem;color:#a78bfa;opacity:0.6;text-decoration:none">Visa p√• JustWatch ‚Üí</a></div>` : ''}
      </div>`;

    resultEl.style.display = 'block';
    resultEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
</script>
</body>
</html>
